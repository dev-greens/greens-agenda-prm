{% extends 'base.html' %}
{% block content %}
<form class="row g-2 align-items-end mb-3" method="get">
  <div class="col-sm-6 col-md-4">
    <label class="form-label">Médico</label>
    <select class="form-select" name="medico">
      <option value="">Todos</option>
      {% for d in doctors %}<option value="{{ d.id }}" {% if selected_doctor == d.id %}selected{% endif %}>{{ d.name }}</option>{% endfor %}
    </select>
  </div>
  <div class="col-sm-6 col-md-3">
    <label class="form-label">Status</label>
    <select class="form-select" name="status">
      <option value="">Todos</option>
      <option value="agendada" {% if selected_status == 'agendada' %}selected{% endif %}>Agendada</option>
      <option value="concluida" {% if selected_status == 'concluida' %}selected{% endif %}>Concluída</option>
      <option value="cancelada" {% if selected_status == 'cancelada' %}selected{% endif %}>Cancelada</option>
    </select>
  </div>
  <div class="col-md-2"><button class="btn btn-brand w-100">Filtrar</button></div>
</form>

<div class="row g-3 mb-1">
  <div class="col-6 col-md-3"><div class="card p-3 text-center"><div class="text-muted small">Médicos</div><div class="fs-4 fw-bold">{{ kpi_total_doctors }}</div></div></div>
  <div class="col-6 col-md-3"><div class="card p-3 text-center"><div class="text-muted small">Consultas</div><div class="fs-4 fw-bold">{{ kpi_total_appts }}</div></div></div>
  <div class="col-4 col-md-2"><div class="card p-3 text-center"><div class="text-muted small">Agendadas</div><div class="fs-5 fw-bold text-primary">{{ kpi_agendada }}</div></div></div>
  <div class="col-4 col-md-2"><div class="card p-3 text-center"><div class="text-muted small">Concluídas</div><div class="fs-5 fw-bold text-success">{{ kpi_concluida }}</div></div></div>
  <div class="col-4 col-md-2"><div class="card p-3 text-center"><div class="text-muted small">Canceladas</div><div class="fs-5 fw-bold text-danger">{{ kpi_cancelada }}</div></div></div>
</div>

<div class="row g-3">
  <div class="col-lg-5">
    <div class="card small-chart"><div class="card-header fw-semibold">Status das Consultas</div><div class="card-body"><canvas id="chartStatus" style="max-height:240px"></canvas></div></div>
  </div>
  <div class="col-lg-7">
    <div class="card small-chart"><div class="card-header fw-semibold">Médicos Mais Ativos</div><div class="card-body"><canvas id="chartTop" style="max-height:240px"></canvas></div></div>
  </div>
</div>

<script>
  const L2={{ status_labels|default:"[]"|safe }}, D2={{ status_data|default:"[]"|safe }};
  const L3={{ top_labels|default:"[]"|safe }}, D3={{ top_data|default:"[]"|safe }};
  function brand(){ return getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()||'#24A259'; }
  function renderDash(){
    if(!window.Chart) return;
    if(window._charts) window._charts.forEach(c=>c.destroy());
    window._charts=[];
    // ensure fixed colors by label order mapping
    const colorMap={'Agendada':'#0d6efd','Concluída':'#198754','Cancelada':'#dc3545'};
    const colors=L2.map(l=>colorMap[l]||brand());
    window._charts.push(new Chart(document.getElementById('chartStatus'), {type:'pie',data:{labels:L2,datasets:[{data:D2,backgroundColor:colors} ]}}));
    window._charts.push(new Chart(document.getElementById('chartTop'), {type:'bar',data:{labels:L3,datasets:[{label:'Consultas',data:D3,backgroundColor:brand()}]},options:{indexAxis:'y',plugins:{legend:{display:false}}}}));
  }
  renderDash(); document.addEventListener('theme:changed', renderDash);
</script>
{% endblock %}
